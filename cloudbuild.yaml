# Cloud Build configuration for automated CI/CD deployment
# Triggered by GitHub repository changes

steps:
  # Step 1: Build and push backend service image to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-backend'
    args:
      - 'build'
      - '-t'
      - 'us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-repo/backend-service:$COMMIT_SHA'
      - '-t'
      - 'us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-repo/backend-service:latest'
      - './backend'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-backend'
    args:
      - 'push'
      - '--all-tags'
      - 'us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-repo/backend-service'

  # Step 2: Build and push frontend service image to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-frontend'
    args:
      - 'build'
      - '-t'
      - 'us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-repo/frontend-service:$COMMIT_SHA'
      - '-t'
      - 'us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-repo/frontend-service:latest'
      - './frontend'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-frontend'
    args:
      - 'push'
      - '--all-tags'
      - 'us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-repo/frontend-service'

  # Step 3: Deploy backend service to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-backend'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - 'backend-service'
      - '--image=us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-repo/backend-service:$COMMIT_SHA'
      - '--platform=managed'
      - '--region=us-central1'
      - '--no-allow-unauthenticated'
      - '--service-account=cloud-run-service-account@$PROJECT_ID.iam.gserviceaccount.com'
      - '--add-cloudsql-instances=$PROJECT_ID:us-central1:web-app-db'
      - '--update-secrets=CLOUD_SQL_CREDENTIALS_SECRET=db-secret:latest'
      - '--ingress=internal'
      - '--set-env-vars=DB_CONNECTION_NAME=$PROJECT_ID:us-central1:web-app-db'
      - '--set-env-vars=DB_USER=postgres'
      - '--set-env-vars=DB_NAME=app_database'
      - '--set-env-vars=PROJECT_ID=$PROJECT_ID'

  # Step 4: Deploy frontend service to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-frontend'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - 'frontend-service'
      - '--image=us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-repo/frontend-service:$COMMIT_SHA'
      - '--platform=managed'
      - '--region=us-central1'
      - '--no-allow-unauthenticated'
      - '--service-account=cloud-run-service-account@$PROJECT_ID.iam.gserviceaccount.com'
      - '--ingress=internal-and-cloud-load-balancing'
      - '--set-env-vars=BACKEND_SERVICE_URL=https://backend-service-<hash>-uc.a.run.app'

  # Step 5: Build and push whatsapp-bot service image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-whatsapp-bot'
    args:
      - 'build'
      - '-t'
      - 'us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-repo/whatsapp-bot:$COMMIT_SHA'
      - '-t'
      - 'us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-repo/whatsapp-bot:latest'
      - './whatsapp_bot'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-whatsapp-bot'
    args:
      - 'push'
      - '--all-tags'
      - 'us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-repo/whatsapp-bot'

  # Step 6: Deploy whatsapp-bot to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-whatsapp-bot'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - 'whatsapp-bot'
      - '--image=us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-repo/whatsapp-bot:$COMMIT_SHA'
      - '--platform=managed'
      - '--region=us-central1'
      - '--allow-unauthenticated'
      - '--service-account=cloud-run-service-account@$PROJECT_ID.iam.gserviceaccount.com'
      - '--min-instances=0'
      - '--max-instances=100'
      - '--memory=256Mi'
      - '--cpu=1'
      - '--timeout=60'
      - '--concurrency=80'
      - '--set-env-vars=LOG_LEVEL=INFO'
      - '--update-secrets=VERIFY_TOKEN=whatsapp-verify-token:latest,META_APP_SECRET=meta-app-secret:latest,WHATSAPP_TOKEN=whatsapp-token:latest,PHONE_NUMBER_ID=whatsapp-phone-id:latest,OPENAI_API_KEY=openai-api-key:latest,VECTOR_STORE_ID=openai-vector-store-id:latest,INMOENTER_API_KEY=inmoenter-api-key:latest,INMOENTER_FEED_URL=inmoenter-feed-url:latest,SYNC_API_KEY=sync-api-key:latest'

# Output images to Artifact Registry
images:
  - 'us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-repo/backend-service:$COMMIT_SHA'
  - 'us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-repo/backend-service:latest'
  - 'us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-repo/frontend-service:$COMMIT_SHA'
  - 'us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-repo/frontend-service:latest'
  - 'us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-repo/whatsapp-bot:$COMMIT_SHA'
  - 'us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-repo/whatsapp-bot:latest'

# Substitutions for Cloud Build variables
substitutions:
  _REGION: 'us-central1'
  _DB_INSTANCE: 'web-app-db'

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'N1_HIGHCPU_8'
